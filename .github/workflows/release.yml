name: Release

on:
  push:
    branches:
      - master

permissions:
  contents: write

env:
  CI: true
  SAVE_ARTIFACT: false

jobs:
  check-commit:
    if: contains(github.event.head_commit.message, 'Version')
    name: Check Commit
    runs-on: ubuntu-latest
    steps:
      - name: Validate if is version commit
        id: validate-message
        run: |
          REGEX="^Version [0-9]+\.[0-9]+\.[0-9]+$"
          COMMIT="${{ github.event.head_commit.message }}"
          [[ $COMMIT =~ $REGEX ]] && exit 0 || exit 1

  extract-information:
    name: Extract Information
    needs: check-commit
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.TAG }}
      version: ${{ steps.tag.outputs.VERSION }}
    steps:
      - id: checkout
        name: Checkout repository
        uses: actions/checkout@v4

      - id: extract
        name: Extract tag and version
        run: |
          # Extract information from commit
          COMMIT="${{ github.event.head_commit.message }}"
          VERSION="$(echo $COMMIT | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+')"
          TAG="v$VERSION"

          # Export information
          echo "TAG=$TAG" >> "$GITHUB_OUTPUT"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

  build-release:
    name: Build Release
    needs: extract-information
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        name: Checkout repository
        uses: actions/checkout@v4

      - id: setup-go
        name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.21.1

      - id: setup-dependencies
        name: Setup dependencies
        run: |
          make deps

      - id: build-binary
        name: Build binary app
        run: |
          make build

      - id: setup-flatpak-dependencies
        name: Setup flatpak dependencies
        run: |
          make flatpak-deps

      - id: build-flatpak
        name: Build flatpak app
        run: |
          make flatpak-build
          make flatpak-bundle

      - id: create-release
        name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ needs.extract-information.outputs.tag }} \
            --title "Version ${{ needs.extract-information.outputs.version }}" \
            --latest \
            --generate-notes \
            LICENSE.md \
            bin/nicedeck \
            bin/nicedeck.flatpak